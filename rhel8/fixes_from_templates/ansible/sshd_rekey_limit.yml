# platform = multi_platform_all
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low



- name: "Force frequent session key renegotiation"
  block:
    - name: "Deduplicate values from /etc/ssh/sshd_config"
      lineinfile:
        path: '/etc/ssh/sshd_config'
        create: no
        regexp: '(?i)^\s*RekeyLimit\s+'
        state: 'absent'
    - name: "Insert correct line to /etc/ssh/sshd_config"
      lineinfile:
        path: '/etc/ssh/sshd_config'
        create: yes
        line: 'RekeyLimit 512M 1h'
        state: present
        insertbefore: '^[#\s]*Match'
        
        validate: '/usr/sbin/sshd -t -f %s'