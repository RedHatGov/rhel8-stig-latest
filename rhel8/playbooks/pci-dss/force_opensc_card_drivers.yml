# platform = Red Hat Enterprise Linux 7,Red Hat Enterprise Linux 8,multi_platform_fedora,multi_platform_rhv,multi_platform_ol
# reboot = false
# strategy = configure
# complexity = low
# disruption = low
- name: Force opensc To Use Defined Smart Card Driver
  hosts: '@@HOSTS@@'
  become: true
  vars:
    var_smartcard_drivers: cac
  tags:
    - CCE-80821-2
    - NIST-800-53-IA-2(1)
    - NIST-800-53-IA-2(2)
    - NIST-800-53-IA-2(3)
    - NIST-800-53-IA-2(4)
    - PCI-DSS-Req-8.3
    - configure_strategy
    - force_opensc_card_drivers
    - low_complexity
    - low_disruption
    - medium_severity
    - no_reboot_needed
  tasks:

    - name: Check existence of opensc conf
      stat:
        path: /etc/opensc-{{ ansible_architecture }}.conf
      register: opensc_conf_fcd
      when: ansible_virtualization_role != "guest" or ansible_virtualization_type
        != "docker"

    - name: Force opensc To Use Defined Smart Card Driver
      lineinfile:
        path: /etc/opensc-{{ ansible_architecture }}.conf
        line: '        force_card_driver = {{ var_smartcard_drivers }}'
        regexp: (^\s+#|^)\s+force_card_driver\s+=\s+.*
        state: present
      when:
        - opensc_conf_fcd.stat.exists
        - ansible_virtualization_role != "guest" or ansible_virtualization_type !=
          "docker"
